<div class="content-wrapper">
  <!-- Header -->
  <div class="page-header">
    <p>Carload List</p>
  </div>

  <!-- Dashboard Summary -->
  <div class="summary-section">
    <div class="summary-cards">
      <div [nzGutter]="8" nz-row>
        <div [nzSpan]="6" nz-col>
          <nz-card nzTitle="Total Carloads">
            <p>{{ totalCarloads | number }}</p>
          </nz-card>
        </div>
        <div [nzSpan]="6" nz-col>
          <nz-card nzTitle="Scheduled">
            <p>{{ totalAgendados | number }}</p>
          </nz-card>
        </div>
        <div [nzSpan]="6" nz-col>
          <nz-card nzTitle="Delivered">
            <p>{{ totalEntregue | number }}</p>
          </nz-card>
        </div>
        <div [nzSpan]="6" nz-col>
          <nz-card nzTitle="Pending">
            <p>{{ totalPendente | number }}</p>
          </nz-card>
        </div>

      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-panel">
    <input
      (ngModelChange)="search()"
      [(ngModel)]="searchValue"
      nz-input
      placeholder="Search..."
      type="text"
    />

    <button (click)="openCarloadDrawer()" nz-button nzType="primary">
      New Carload
    </button>

    <button (click)="setFilterMode('ALL')" [nzType]="filterMode==='ALL' ? 'primary' : 'default'" nz-button>
      All
    </button>
    <button (click)="setFilterMode('SCHEDULED')" [nzType]="filterMode==='SCHEDULED' ? 'primary' : 'default'" nz-button>
      Scheduled
    </button>
    <button (click)="setFilterMode('DELIVERED')" [nzType]="filterMode==='DELIVERED' ? 'primary' : 'default'" nz-button>
      Delivered
    </button>
    <button (click)="setFilterMode('PENDING')" [nzType]="filterMode==='PENDING' ? 'primary' : 'default'" nz-button>
      Pending
    </button>

    <nz-range-picker
      (ngModelChange)="applyFilter()"
      [(ngModel)]="dateRange"
      [nzAllowClear]="true"
      nzPlaceholder="Filter by date range"
    ></nz-range-picker>
  </div>

  <!-- Data Table -->
  <div class="table-wrapper">
    <nz-spin [nzSpinning]="loadingCarloads" nzTip="A carregar carloads...">
      <div class="table-scroll">
        <nz-table
          #nzTable
          [nzData]="listOfDisplayData"
          [nzScroll]="{ x: '1050px', y: '280px' }"
          nzTableLayout="fixed"
        >
          <thead>
          <tr>
            <th>Destination</th>
            <th>Client</th>
            <th>Phone</th>
            <th *ngIf="filterMode !== 'SCHEDULED'">Driver</th>
            <th>Material</th>
            <th *ngIf="filterMode !== 'SCHEDULED'" class="batch-column">Batch</th>
            <th *ngIf="filterMode !== 'SCHEDULED'">Total Spent</th>
            <th>Earnings</th>
            <th>Status</th>
            <th *ngIf="filterMode === 'SCHEDULED'">Delivery Date</th>
            <th>Actions</th>
          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let carload of nzTable.data">
            <!-- Destination -->
            <td>
              <ng-container
                *ngIf="editingCarload?.id === carload.id && editingField === 'deliveryDestination'; else viewDestination">
                <input (blur)="saveInlineEdit(carload, 'deliveryDestination')"
                       (keyup.enter)="saveInlineEdit(carload, 'deliveryDestination')"
                       [(ngModel)]="editingCarload!.deliveryDestination"
                       nz-input/>
              </ng-container>
              <ng-template #viewDestination>
                <span (click)="startInlineEdit(carload, 'deliveryDestination')" class="editable-cell">
                  {{ carload.deliveryDestination }}
                </span>
              </ng-template>
            </td>

            <td>
              <ng-container
                *ngIf="editingCarload?.id === carload.id && editingField === 'customerName'; else viewCustomerName">
                <input (blur)="saveInlineEdit(carload, 'customerName')"
                       (keyup.enter)="saveInlineEdit(carload, 'customerName')"
                       [(ngModel)]="editingCarload!.customerName"
                       nz-input/>
              </ng-container>
              <ng-template #viewCustomerName>
                <span (click)="startInlineEdit(carload, 'customerName')" class="editable-cell">
                  {{ carload.customerName }}
                </span>
              </ng-template>
            </td>

            <td>
              <ng-container
                *ngIf="editingCarload?.id === carload.id && editingField === 'customerPhoneNumber'; else viewPhone">
                <input (blur)="saveInlineEdit(carload, 'customerPhoneNumber')"
                       (keyup.enter)="saveInlineEdit(carload, 'customerPhoneNumber')"
                       [(ngModel)]="editingCarload!.customerPhoneNumber"
                       nz-input/>
              </ng-container>
              <ng-template #viewPhone>
                <span (click)="startInlineEdit(carload, 'customerPhoneNumber')" class="editable-cell">
                  {{ carload.customerPhoneNumber }}
                </span>
              </ng-template>
            </td>

            <td *ngIf="filterMode !=='SCHEDULED'">{{ carload.assignedDriverName }}</td>
            <td>{{ carload.transportedMaterial }}</td>
            <td *ngIf="filterMode !== 'SCHEDULED'" class="batch-column">{{ carload.carloadBatchName }}</td>
            <td *ngIf="filterMode !== 'SCHEDULED'">{{ carload.totalSpent | currency:'MZN':'symbol':'1.2-2' }}</td>
            <td>{{ carload.totalEarnings | currency:'MZN':'symbol':'1.2-2' }}</td>
            <td>
              <button [nzDropdownMenu]="menu" nz-button nz-dropdown nzTrigger="click">
                <nz-tag
                  [nzColor]=
                    "carload.deliveryStatus === 'DELIVERED' ? 'green' : carload.deliveryStatus === 'PENDING' ? 'orange' : 'blue' ">
                  {{ carload.deliveryStatus }}
                </nz-tag>
              </button>
              <nz-dropdown-menu #menu="nzDropdownMenu">
                <ul nz-menu>
                  <li (click)="updateCarloadStatus(carload, 'DELIVERED')" nz-menu-item>Delivered</li>
                  <li (click)="updateCarloadStatus(carload, 'PENDING')" nz-menu-item>Pending</li>
                  <li (click)="updateCarloadStatus(carload, 'SCHEDULED')" nz-menu-item>Scheduled</li>
                  <li (click)="updateCarloadStatus(carload, 'CANCELLED')" nz-menu-item>Canceled</li>
                </ul>
              </nz-dropdown-menu>
            </td>
            <td *ngIf="filterMode === 'SCHEDULED'">
              {{ carload.deliveryScheduledDate ? (carload.deliveryScheduledDate | date:'dd/MM/yyyy') : '—' }}
            </td>
            <td>
              <button (click)="encerarCarload(carload)" *ngIf="isShowingScheduledOnly" nz-button nzSize="small"
                      nzType="link">
                <nz-icon nzTheme="outline" nzType="copyright-circle"/>
              </button>
              <button (click)="editCarload(carload)" nz-button nzSize="small" nzType="link">
                <nz-icon nzTheme="outline" nzType="edit"></nz-icon>
              </button>
              <button (click)="deleteCarload(carload)" nz-button nzDanger nzSize="small" nzType="link">
                <nz-icon nzTheme="outline" nzType="delete"></nz-icon>
              </button>
            </td>
          </tr>
          </tbody>
        </nz-table>
      </div>
    </nz-spin>
  </div>
</div>


<!-- Carload Drawer -->
<!-- Carload Drawer -->
<nz-drawer
  (nzOnClose)="closeCarloadDrawer()"
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzFooter]="drawerFooterTemplate"
  [nzVisible]="isCarloadDrawerVisible"
  [nzWidth]="720"
  nzTitle="New Carload"
>
  <form *nzDrawerContent [formGroup]="carloadForm" class="drawer-form" nz-form>

    <!-- Client Information -->
    <div class="drawer-section">
      <h3 class="section-title">Client Information</h3>
      <div [nzGutter]="16" nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Client Name</nz-form-label>
            <nz-form-control>
              <input formControlName="customerName" nz-input placeholder="Client name"/>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Client Phone</nz-form-label>
            <nz-form-control>
              <nz-input-group nzAddOnBefore="+258">
                <input formControlName="customerPhoneNumber" nz-input placeholder="Phone number"/>
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </div>

    <!-- Team Assignment -->
    <div class="drawer-section">
      <h3 class="section-title">Team</h3>
      <div [nzGutter]="16" nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Assigned Driver</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="assignedDriverId" nzPlaceHolder="Select driver">
                <nz-option *ngFor="let driver of dataDrivers" [nzLabel]="driver.Name" [nzValue]="driver.id"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Assigned Manager</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="logisticsManagerId" nzPlaceHolder="Select manager">
                <nz-option *ngFor="let manager of dataManagers" [nzLabel]="manager.name"
                           [nzValue]="manager.id"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </div>

    <!-- Material and Batch -->
    <div class="drawer-section">
      <h3 class="section-title">Material & Batch</h3>
      <div [nzGutter]="16" nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Transported Material</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="transportedMaterial" nzPlaceHolder="Select material">
                <nz-option nzLabel="Areia grossa" nzValue="Areia grossa"></nz-option>
                <nz-option nzLabel="Areia fina" nzValue="Areia fina"></nz-option>
                <nz-option nzLabel="Areia vermelha/saibro" nzValue="Areia vermelha/saibro"></nz-option>
                <nz-option nzLabel="Pedra 3/4" nzValue="Pedra 3/4"></nz-option>
                <nz-option nzLabel="Pedra Sarrisca" nzValue="Pedra Sarrisca"></nz-option>
                <nz-option nzLabel="Pedra Enricamento" nzValue="Pedra Enricamento"></nz-option>
                <nz-option nzLabel="Pó de pedra" nzValue="Pó de pedra"></nz-option>
                <nz-option nzLabel="Outros" nzValue="Outros"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Batch Name</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="carloadBatchId" nzPlaceHolder="Select batch">
                <nz-option *ngFor="let sprint of dataSprint" [nzLabel]="sprint.name" [nzValue]="sprint.id"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Destination</nz-form-label>
            <nz-form-control nzErrorTip="Enter delivery destination">
              <input formControlName="deliveryDestination" nz-input placeholder="Ex: Matola, Boane..."/>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </div>

    <!-- Financial & Delivery -->
    <div class="drawer-section">
      <h3 class="section-title">Financial & Delivery</h3>
      <div [nzGutter]="16" nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Total Spent</nz-form-label>
            <nz-form-control>
              <nz-input-group nzAddOnBefore="MZN">
                <input formControlName="totalSpent" nz-input placeholder="Total spent" type="number"/>
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Total Earnings</nz-form-label>
            <nz-form-control>
              <nz-input-group nzAddOnBefore="MZN">
                <input formControlName="totalEarnings" nz-input placeholder="Total earnings" type="number"/>
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div [nzGutter]="16" nz-row>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Status</nz-form-label>
            <nz-form-control>
              <nz-select (ngModelChange)="onStatusChange($event)" formControlName="deliveryStatus"
                         nzPlaceHolder="Select status">
                <nz-option nzLabel="Delivered" nzValue="DELIVERED"></nz-option>
                <nz-option nzLabel="Pending" nzValue="PENDING"></nz-option>
                <nz-option nzLabel="Scheduled" nzValue="SCHEDULED"></nz-option>
                <nz-option nzLabel="Canceled" nzValue="CANCELED"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div *ngIf="showDeliveryDateField" nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label nzRequired>Delivery Date</nz-form-label>
            <nz-form-control>
              <nz-date-picker (ngModelChange)="onChange($event)"
                              formControlName="deliveryScheduledDate"></nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </div>

    <br/>

    <!-- ===== UI: Saving Spinner ===== -->
    <div *ngIf="isSaving" class="drawer-spinner">
      <nz-spin nzSize="large"></nz-spin>
      <br/>
      <p>Saving Carload... Please wait.</p>
    </div>
  </form>

  <!-- Footer -->
  <ng-template #drawerFooterTemplate>
    <div class="drawer-footer">
      <button (click)="closeCarloadDrawer()"
              class="btn-cancel"
              nz-button nzType=
                "default">Cancel
      </button>
      <button
        (click)="submitCarload()"
        [disabled]="carloadForm.invalid || savingCarload"
        class="btn-save"
        nz-button
        nzType="primary"
      >
        Save
      </button>
    </div>
  </ng-template>
</nz-drawer>



<div class="content-wrapper">
  <!-- ====================== HEADER ====================== -->
  <div class="page-header">
    <p>Carload Cotacao</p>
  </div>

  <!-- ====================== FILTERS ====================== -->
  <!-- ====================== FILTERS ====================== -->
  <div class="filters-panel">
    <!-- Campo de pesquisa -->
    <input
      (ngModelChange)="search()"
      [(ngModel)]="searchValue"
      nz-input
      placeholder="Search..."/>

    <!-- Botão Nova Fatura -->
    <button (click)="openDrawer()" nz-button nzType="primary">
      New Cotacao
    </button>

    <!-- Seletor de cliente -->
    <nz-select
      (ngModelChange)="filterByCustomer()"
      [(ngModel)]="selectedCustomerId"
      nzAllowClear
      nzPlaceHolder="Select customer">
      <nz-option
        *ngFor="let customer of dataCustomer"
        [nzLabel]="customer.name"
        [nzValue]="customer.id">
      </nz-option>
    </nz-select>

    <!-- Date Range Picker -->
    <nz-range-picker
      (ngModelChange)="filterByDateRange()"
      [(ngModel)]="dateRange"
      nzFormat="dd/MM/yyyy"
      nzPlaceHolder="Select date range">
    </nz-range-picker>


  </div>


  <!-- ====================== TABLE ====================== -->
  <div class="table-wrapper">
    <div class="table-scroll">
      <nz-spin
        [nzSpinning]="isLoading"
        nzSize="large"
        nzTip="A carregar Cotacoes..."
      >
        <nz-table
          #nzTable
          [nzData]="cotacoes"
          [nzScroll]="{ x: '1400px', y: '300px' }"
          nzTableLayout="fixed">
          <thead>
          <tr>
            <th>Customer Own</th>
            <th>Cotacao Code</th>
            <th class="file-name-column">File Name</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let cotacao of nzTable.data">
            <td>{{ cotacao.carloadCustomerName }}</td>
            <td>{{ cotacao.cotacaoCode }}</td>
            <td class="file-name-cell">
              <a
                (click)="downloadCotacao(cotacao)"
                class="file-link"
                target="_blank">
                {{ cotacao.fileName }}
              </a>
            </td>
            <td>{{ cotacao.createdAt | date: 'dd/MM/yyyy - HH:mm' }}</td>
            <td class="action-buttons">
              <button
                (click)="downloadCotacao(cotacao)"
                nz-button
                nz-tooltip="Download"
                nzSize="small"
                nzType="link">
                <nz-icon nzTheme="outline" nzType="printer"></nz-icon>
              </button>

              <button
                (click)="editCotacao(cotacao)"
                nz-button
                nz-tooltip="Edit"
                nzSize="small"
                nzType="link">
                <nz-icon nzTheme="outline" nzType="edit"></nz-icon>
              </button>

              <button
                (click)="deleteCotacao(cotacao)"
                nz-button
                nz-tooltip="Delete"
                nzDanger
                nzSize="small"
                nzType="link">
                <nz-icon nzTheme="outline" nzType="delete"></nz-icon>
              </button>
            </td>
          </tr>
          </tbody>
        </nz-table>
      </nz-spin>
    </div>
  </div>
</div>

<!-- ====================== DRAWER ====================== -->
<nz-drawer
  (nzOnClose)="closeDrawer()"
  [nzFooter]="drawerFooter"
  [nzTitle]="currentCotacaoId ? 'Edit Cotacao' : 'New Cotacao'"
  [nzVisible]="isDrawerVisible"
  [nzWidth]="1000">

  <form *nzDrawerContent [formGroup]="cotacaoForm" class="drawer-form" nz-form>
    <!-- CLIENT INFO -->
    <div class="drawer-section">
      <h3 class="section-title">Customer Information</h3>

      <nz-form-item>
        <nz-form-label nzRequired>Cliente</nz-form-label>
        <nz-form-control>
          <nz-select
            formControlName="carloadCustomerId"
            nzPlaceHolder="Nome do Cliente">
            <nz-option
              *ngFor="let customer of dataCustomer"
              [nzLabel]="customer.name"
              [nzValue]="customer.id">
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>Cotacao Code</nz-form-label>
        <nz-form-control>
          <input formControlName="cotacaoCode" nz-input readonly/>
        </nz-form-control>
      </nz-form-item>
    </div>

    <!-- ITEMS SECTION -->
    <div class="drawer-section">
      <h3 class="section-title">Cotacao Items</h3>

      <div class="items-list" formArrayName="items">
        <div
          *ngFor="let item of items.controls; let i = index"
          [formGroupName]="i"
          class="item-row">
          <nz-form-item>
            <nz-form-label nzRequired>Item</nz-form-label>
            <nz-form-control>
              <nz-select
                (ngModelChange)="onItemChange($event, i)"
                formControlName="description"
                nzPlaceHolder="Selecione o item">
                <nz-option
                  *ngFor="let it of itemsOptions"
                  [nzLabel]="it"
                  [nzValue]="it">
                </nz-option>
              </nz-select>

            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Quantidade</nz-form-label>
            <nz-form-control>
              <input formControlName="quantity" nz-input type="number"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Preço Unitário</nz-form-label>
            <nz-form-control>
              <input formControlName="unitPrice" nz-input type="number"/>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label>Subtotal</nz-form-label>
            <nz-form-control>
              <input formControlName="amount" nz-input readonly/>
            </nz-form-control>
          </nz-form-item>

          <button
            (click)="removeItem(i)"
            class="remove-btn"
            nz-button
            nzType="default"
            type="button">
            <nz-icon nzType="minus-circle"></nz-icon>
            Remover
          </button>
        </div>
      </div>

      <button
        (click)="addItem()"
        class="add-item-btn"
        nz-button
        nzType="dashed"
        type="button">
        <nz-icon nzType="plus"></nz-icon>
        Adicionar Item
      </button>
    </div>

    <!-- TOTALS SECTION -->
    <div class="drawer-section totals-section">
      <h3 class="section-title">Totals</h3>

      <div class="totals-grid">
        <nz-form-item>
          <nz-form-label nzRequired>Taxa (%)</nz-form-label>
          <nz-form-control>
            <input formControlName="taxRate" nz-input type="number"/>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>Subtotal</nz-form-label>
          <nz-form-control>
            <input formControlName="subtotal" nz-input readonly/>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>Tax</nz-form-label>
          <nz-form-control>
            <input formControlName="tax" nz-input readonly/>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>Total</nz-form-label>
          <nz-form-control>
            <input formControlName="total" nz-input readonly/>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>
    <!-- ===== UI: Saving Spinner ===== -->
    <div *ngIf="isSaving" class="drawer-spinner">
      <nz-spin nzSize="large"></nz-spin>
      <br/>
      <p>Saving Quotation... Please wait.</p>
    </div>
  </form>




  <!-- ====================== FOOTER ====================== -->
  <ng-template #drawerFooter>
    <div class="drawer-footer">
      <button (click)="closeDrawer()"
              class="btn-cancel"
              nz-button>Cancelar</button>
      <button
        (click)="submitCotacao()"
        [disabled]="!cotacaoForm.valid"
        class="btn-save"
        nz-button
        nzType="primary">
        Salvar
      </button>
    </div>
  </ng-template>
</nz-drawer>

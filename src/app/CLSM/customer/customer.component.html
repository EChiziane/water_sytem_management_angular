<div class="content-wrapper">

  <!-- ===== Page Header ===== -->
  <div class="page-header">
    <p>Lista dos Clientes</p>

    <span class="back-arrow" (click)="onBack()">
      <nz-icon nzType="arrow-left" nzTheme="outline"></nz-icon>
    </span>
  </div>

  <!-- ===== Summary Section ===== -->
  <div class="summary-section">
    <div class="summary-background">
      <div nz-row [nzGutter]="8">

        <!-- Total Customers -->
        <div nz-col [nzSpan]="8">
          <nz-card nzTitle="Total Customers">
            <p>{{ totalCustomers }}</p>
          </nz-card>
        </div>

        <!-- Active Customers -->
        <div nz-col [nzSpan]="8">
          <nz-card nzTitle="Active Customers">
            <p>{{ activeCustomers }}</p>
          </nz-card>
        </div>

        <!-- Inactive Customers -->
        <div nz-col [nzSpan]="8">
          <nz-card nzTitle="Inactive Customers">
            <p>{{ inactiveCustomers }}</p>
          </nz-card>
        </div>

      </div>
    </div>
  </div>

  <!-- ===== Filters Panel ===== -->
  <div class="filters-panel">
    <input
      nz-input
      type="text"
      placeholder="Search name"
      [(ngModel)]="searchValue"
      (ngModelChange)="search()"
    />

    <button nz-button nzType="primary" (click)="open()">Novo Customer</button>
    <button nz-button nzType="primary" (click)="openPaymentDrawer()">Novo Payment</button>
  </div>

  <!-- ===== Table Wrapper ===== -->
  <div class="table-wrapper">
    <div class="table-scroll">
      <nz-spin
        nzSize="large"
        nzTip="A carregar Customer..."
        [nzSpinning]="isLoading">

        <!-- ===== Customers Table ===== -->
        <nz-table
          #nzTable
          nzTableLayout="fixed"
          [nzData]="listOfDisplayData"
          [nzScroll]="{ x: '1150px', y: '280px' }">

          <thead>
          <tr>

            <!-- Name Column with Filter -->
            <th nzCustomFilter>
              Name
              <nz-filter-trigger
                [nzActive]="searchValue.length > 0"
                [nzDropdownMenu]="menu"
                [(nzVisible)]="visible">
                <nz-icon nzType="search"></nz-icon>
              </nz-filter-trigger>
            </th>

            <th>Contact</th>
            <th>Months</th>
            <th>Status</th>
            <th>Valve</th>
            <th>Tax</th>
            <th>Created At</th>
            <th>Actions</th>

          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let data of nzTable.data">

            <td>{{ data.name }}</td>
            <td>{{ data.contact }}</td>
            <td>{{ data.monthsInDebt }}</td>

            <td>
              <nz-tag [nzColor]="data.status === 'ATIVO' ? 'green' : 'red'">
                {{ data.status }}
              </nz-tag>
            </td>

            <td>{{ data.valve }}</td>
            <td>{{ data.valve }}</td>
            <td>{{ data.createdAt | date: 'dd MM yyyy - HH:mm' }}</td>

            <td>
              <!-- View -->
              <button
                nz-button
                nzType="link"
                nzSize="small"
                (click)="viewCustomer(data)"
                [routerLink]="['/customer-detail', data.id]">
                <nz-icon nzType="eye" nzTheme="outline"></nz-icon>
              </button>

              <!-- Edit -->
              <button
                nz-button
                nzType="link"
                nzSize="small"
                (click)="editCustomer(data)">
                <nz-icon nzType="edit" nzTheme="outline"></nz-icon>
              </button>

              <!-- Delete -->
              <button
                nz-button
                nzDanger
                nzType="link"
                nzSize="small"
                (click)="deleteCustomer(data)">
                <nz-icon nzType="delete" nzTheme="outline"></nz-icon>
              </button>
            </td>

          </tr>
          </tbody>

        </nz-table>
      </nz-spin>

      <!-- ===== Table Filter Dropdown ===== -->
      <nz-dropdown-menu #menu="nzDropdownMenu">
        <div class="ant-table-filter-dropdown">
          <div class="search-box">

            <input
              nz-input
              type="text"
              placeholder="Search name"
              [(ngModel)]="searchValue"
              (ngModelChange)="search()"
            />

            <button nz-button nzSize="small" nzType="primary" (click)="search()">Search</button>
            <button nz-button nzSize="small" (click)="reset()">Reset</button>

          </div>
        </div>
      </nz-dropdown-menu>

    </div>
  </div>
</div>

<!-- ====================================================== -->
<!-- ============== CUSTOMER DRAWER ======================== -->
<!-- ====================================================== -->

<nz-drawer
  [nzVisible]="isCustomerDrawerVisible"
  [nzWidth]="720"
  [nzFooter]="customerDrawerFooter"
  [nzMaskClosable]="false"
  [nzTitle]="customerDrawerTitle"
  [nzBodyStyle]="{ overflow: 'auto' }"
  (nzOnClose)="closeCustomerDrawer()">

  <form
    nz-form
    *nzDrawerContent
    [formGroup]="customerForm"
    class="drawer-form">

    <!-- ===== Section: Basic Information ===== -->
    <div class="drawer-section">
      <h3 class="section-title">Basic Information</h3>

      <div nz-row [nzGutter]="16">

        <!-- Name -->
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Nome</nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="name" placeholder="Digite o nome do cliente" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Contact -->
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Contato</nz-form-label>
            <nz-form-control>
              <nz-input-group nzAddOnBefore="+258">
                <input
                  nz-input
                  formControlName="contact"
                  placeholder="Digite o contato" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>

      </div>

      <div nz-row [nzGutter]="16">

        <!-- Address -->
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Endereço</nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="address" placeholder="Digite o endereço" />
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Status -->
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Status</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="status" nzPlaceHolder="Selecione o status">
                <nz-option nzLabel="ATIVO" nzValue="ATIVO"></nz-option>
                <nz-option nzLabel="INATIVO" nzValue="INATIVO"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

      </div>

      <div nz-row [nzGutter]="16">

        <!-- Valve -->
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Valve</nz-form-label>
            <nz-form-control>
              <nz-input-group nzAddOnBefore="MZN">
                <input
                  nz-input
                  type="number"
                  formControlName="valve"
                  placeholder="Digite a válvula" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>

        <!-- Months in Debt -->
        <div nz-col nzSpan="12">
          <nz-form-item>
            <nz-form-label>Meses em Dívida</nz-form-label>
            <nz-form-control>
              <input
                nz-input
                type="number"
                formControlName="monthsInDebt"
                placeholder="Digite os meses" />
            </nz-form-control>
          </nz-form-item>
        </div>

      </div>

    </div>
  </form>

  <!-- Drawer Footer -->
  <ng-template #customerDrawerFooter>
    <div class="drawer-footer">
      <button nz-button (click)="closeCustomerDrawer()" style="margin-right: 8px;">Cancelar</button>
      <button nz-button nzType="primary" (click)="createCustomer()">
        {{ isEditMode ? 'Salvar' : 'Criar' }}
      </button>
    </div>
  </ng-template>

</nz-drawer>

<!-- ====================================================== -->
<!-- ============== PAYMENT DRAWER ========================= -->
<!-- ====================================================== -->

<nz-drawer
  nzTitle="Create Payment"
  [nzVisible]="paymentDrawerVisible"
  [nzFooter]="paymentFooterTpl"
  [nzWidth]="720"
  [nzMaskClosable]="false"
  [nzBodyStyle]="{ overflow: 'auto' }"
  (nzOnClose)="closePaymentDrawer()">

  <form
    nz-form
    *nzDrawerContent
    [formGroup]="paymentForm"
    (ngSubmit)="createPayment()">

    <!-- Amount + Payment Method -->
    <div nz-row [nzGutter]="16">

      <!-- Amount -->
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label>Amount</nz-form-label>
          <nz-form-control>
            <input nz-input formControlName="amount" type="number" placeholder="Enter payment amount" />
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- Payment Method -->
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label>Payment Method</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="paymentMethod" nzPlaceHolder="Selecione o método de pagamento">
              <nz-option nzLabel="EMOLA" nzValue="EMOLA"></nz-option>
              <nz-option nzLabel="MPESA" nzValue="MPESA"></nz-option>
              <nz-option nzLabel="BCI" nzValue="BCI"></nz-option>
              <nz-option nzLabel="NUMERARIO" nzValue="NUMERARIO"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

    </div>

    <!-- Months + Customer -->
    <div nz-row [nzGutter]="16">

      <!-- Months -->
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label>Months</nz-form-label>
          <nz-form-control>
            <input nz-input formControlName="numMonths" placeholder="Enter number of months" />
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- Customer -->
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label>Customer</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="customerId" nzPlaceHolder="Select Customer">
              <nz-option
                *ngFor="let customer of dataCostumers"
                [nzLabel]="customer.name"
                [nzValue]="customer.id">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

    </div>

    <!-- Confirmed -->
    <div nz-row [nzGutter]="16">
      <div nz-col nzSpan="12">
        <nz-form-item>
          <nz-form-label>Confirmed</nz-form-label>
          <nz-form-control>
            <nz-switch formControlName="confirmed"></nz-switch>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>

  </form>

  <ng-template #paymentFooterTpl>
    <div style="float: right;">
      <button nz-button (click)="closePaymentDrawer()" style="margin-right: 8px;">Cancel</button>
      <button nz-button nzType="primary" (click)="createPayment()">Submit</button>
    </div>
  </ng-template>

</nz-drawer>
